"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),FILTER_REG_EXP=/[^0-9]/g,ALLOWED_KEYS={Delete:[46],Backspace:[8],ArrowLeft:[37],ArrowRight:[39],F5:[116],number:[48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105]},PATTERN_NUMBER_SYM="n",KEYS_NAMES=Object.keys(ALLOWED_KEYS),NicePhone=function(){function e(t){var s=this;_classCallCheck(this,e),this.element=t.element,this.emptyChar=t.emptyChar||"",this.pattern=t.pattern,this.changeCallback=t.changeCallback||null,this.successCallback=t.successCallback||null,void 0===t.canDestroyMask?this.canDestroyMask=!0:this.canDestroyMask=t.canDestroyMask,this.specials=[],this.backSpaceHits=[3],this.destroyed=!1;var i=this.pattern.split(PATTERN_NUMBER_SYM);this.numOfNumbers=i.length-1;for(var a=0;a<this.pattern.length;a++)if(" "!==this.pattern[a]){var n=1*this.pattern[a];isNaN(n)||"number"!=typeof n||this.numOfNumbers++}i.forEach(function(e,t){s.specials=s.specials.concat(0===t?e:e.split(""))}),this.specials=this.specials.filter(function(e,t,s){return e&&s.indexOf(e)===t}),this.events={click:this.onClick.bind(this),keydown:this.onKeyDown.bind(this),paste:this.onPaste.bind(this),input:this.onInput.bind(this)},this.element.addEventListener("click",this.events.click),this.element.addEventListener("input",this.events.input),this.element.addEventListener("keydown",this.events.keydown),this.element.addEventListener("paste",this.events.paste),this.element.value=this.passStr("")}return _createClass(e,[{key:"deleteStartSpecSyms",value:function(e){for(var t=this.specials[0],s=0;s<t.length&&t[s]===e[s];s++)e=e.substr(1),t=t.substr(1);return e}},{key:"filterByRegExp",value:function(e){return e.replace(FILTER_REG_EXP,"")}},{key:"filterStr",value:function(e){return this.filterByRegExp(this.deleteStartSpecSyms(e))}},{key:"passStr",value:function(e){for(var t=this.filterStr(e),s=this.specials[0].length,i="",a=0,n=0;(a<(t.length||s)||this.emptyChar)&&n<this.pattern.length;a++,n++){for(var h=t[a]||this.emptyChar;this.pattern[n]!==PATTERN_NUMBER_SYM;)i+=this.pattern[n],n++;i+=h}return i}},{key:"updateFromRaw",value:function(e){e=e||"";var t=this.passStr(e);this.element.value=t,"function"==typeof this.changeCallback&&this.changeCallback(t,null)}},{key:"getPos",value:function(){return this.element.selectionStart}},{key:"setPos",value:function(e){this.element.selectionStart=e,this.element.selectionEnd=e}},{key:"setMinPos",value:function(){this.setPos(this._getMinPos())}},{key:"focus",value:function(){this.element.focus(),this.setMinPos()}},{key:"_getNewPos",value:function(e,t,s,i){var a=void 0,n=void 0;switch(t){case"Backspace":n=i+1,a=i;break;case"Delete":a=i,n=i;break;default:a=i,n=i-1,s&&(a+=s.length)}for(var h=n;h<a;h++)for(var r=0;r<this.specials.length;r++){var l=this.specials[r],c=e.substr(h,l.length)===l;c&&(a+=l.length)}return a}},{key:"_isCorrectPos",value:function(e,t){t=t||this.getPos();var s=void 0;switch(e){case"ArrowRight":s=1;break;default:s=-1}t+=s;for(var i=this.element.value[t];-1!==this.specials.indexOf(i);)t+=s,i=this.element.value[t];return i!==this.emptyChar&&this.getPos()+s>=this.specials[0].length}},{key:"_getMinPos",value:function(){var e=this.element.value.indexOf(this.emptyChar);return e=Math.max(e,this.specials[0].length)}},{key:"isValid",value:function(){return this.element.value.replace(this.emptyChar,"").length===this.pattern.length}},{key:"onClick",value:function(){this._isCorrectPos()||this.setPos(this._getMinPos())}},{key:"onKeyDown",value:function(e){var t=this,s=e.key;if(!s){var i=e.keyCode||e.which;KEYS_NAMES.every(function(e){return-1===ALLOWED_KEYS[e].indexOf(i)||(s=e,!1)})}var a=1*s>=0||"number"===s;if(!e.ctrlKey&&-1===KEYS_NAMES.indexOf(s)&&!a&&!e.metaKey)return void e.preventDefault();if(this.lastKey=s,!this.destroyed)switch(s){case"Backspace":if(!this._isCorrectPos(s)){e.preventDefault(),this.backSpaceHits[1]=this.backSpaceHits[0]&&!this.backSpaceHits[1]?event.timeStamp:this.backSpaceHits[1],this.backSpaceHits[0]=this.backSpaceHits[0]?this.backSpaceHits[0]:e.timeStamp;var n=this.backSpaceHits[1]-this.backSpaceHits[0];this.backSpaceHits[1]&&n<600&&(this.destroyMask(),this.backSpaceHits=[0,0],this.element.value=""),this.backSpaceHits[1]||setTimeout(function(){t.backSpaceHits=[0,0]},650)}break;case"ArrowLeft":case"ArrowRight":this._isCorrectPos(s)||(e.preventDefault(),this.setPos(this._getMinPos()))}}},{key:"onPaste",value:function(e){var t=this.getPos(),s=e.clipboardData,i=s.getData("text");i=this.filterStr(i),i.length>this.numOfNumbers&&(i=i.slice(-this.numOfNumbers)),e.preventDefault();var a=this.element.value.substr(0,t)+i+this.element.value.substr(t+i.length),n=this.passStr(a),h=this._getNewPos(n,null,i,t);this.element.value=n,this.setPos(h),"function"==typeof this.changeCallback&&this.changeCallback(n,h)}},{key:"onInput",value:function(){var e=void 0,t=void 0;this.destroyed?(e=this.element.value,t=this.getPos()):(e=this.passStr(this.element.value),t=this._getNewPos(e,this.lastKey,null,this.getPos()),this.element.value=e,this.setPos(t)),"function"==typeof this.changeCallback&&this.changeCallback(e,t),"function"==typeof this.successCallback&&this.filterByRegExp(e).length===this.numOfNumbers&&this.successCallback()}},{key:"destroyMask",value:function(){this.element.removeEventListener("click",this.events.click),this.element.removeEventListener("paste",this.events.paste),this.destroyed=!0}}]),e}();window.NicePhone=NicePhone;